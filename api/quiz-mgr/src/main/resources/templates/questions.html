<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf_token" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <link rel="stylesheet" type="text/css" href="../static/styles.css" th:href="@{/styles.css}">
    <title th:text="${quizTitle}">Quiz</title>
</head>
<body>
    <h1>WEBBISKOOLS&nbsp;LTD QUIZ&nbsp;MANAGER</h1>
    <a href="/logout" class="logout-link">Sign out</a>
    <h2 th:text="${'Quiz: ' + quizTitle}">Quiz title</h2>
    <p style="font-weight:bold">Enter details below to create a new answer for a question</p>
    <form id="new-question-form" th:if="${permission==1}">
        <input type="hidden" id="quiz-id" name="quiz-id" value="${quizId}">
        <label for="enteredQuestion">Question ID: </label>
        <input id="enteredQuestion" name="question" type="number"/>
        <label for="enteredAnswer">Answer: </label>
        <input id="enteredAnswer" name="answer" type="text"/>
        <button onclick="createAnswerFromForm()">Submit</button>
    </form>
    <div id="questions-list">
        <p th:if="${permission==1}">Click on a question to show/hide the possible answers and the question editor options.</p>
        <p th:if="${permission==2}">Click on a question to show/hide the possible answers.</p>
        <div class="question-box"
             th:attr="onclick=${(permission==1 || permission==2) ? 'toggleAnswerVisibility(' + question.getQuestionIndex() + ')' : ''}"
             th:each="question:${questions}">
            <div th:id="${'editor-controls-for-q' + question.getQuestionIndex()}"
                 class="editor-controls"
                 th:if="${permission==1}"
                 hidden>
                <button class="editor-action question-edit-button" th:text="${'Edit question ' + question.getQuestionIndex()}" disabled></button>
                <button class="editor-action question-delete-button" th:text="${'Delete question ' + question.getQuestionIndex()}" disabled></button>
            </div>
            <p class="question-text" th:text="${question.getQuestionIndex() + '. ' + question.getQuestionText()}"></p>
            <div th:id="${'answers-for-q' + question.getQuestionIndex()}"
                 class="answers-list"
                 th:if="${permission==1 || permission ==2}"
                 hidden>
                <ul class="answer-text"
                    th:each="answer:${answers}"
                    th:if="${answer.getQuestionId()} == ${question.getId()}"
                    th:text="${answer.getAnswerIndex() + '. ' + answer.getAnswerText()}"></ul>
            </div>
        </div>
    </div>

    <script th:if="${permission==1 || permission ==2}">
        function toggleAnswerVisibility(questionNumber) {
            let answers = document.getElementById("answers-for-q" + questionNumber);
            let controls = document.getElementById("editor-controls-for-q" + questionNumber);
            let isHidden = controls ? (answers.hidden && controls.hidden) : answers.hidden;
            answers.hidden = !isHidden;
            if (controls) { controls.hidden = !isHidden; }
        }
    </script>

    <script th:if="${permission==1}">
        function createAnswer(questionId, answerText) {
            if ((typeof questionId != "number") || (typeof answerText != "string")) {
                console.log("invalid parameters!");
                return;
            }
            let csrfHeader = document.getElementsByTagName("meta").namedItem("_csrf_header").getAttribute("content");
            let csrfToken = document.getElementsByTagName("meta").namedItem("_csrf_token").getAttribute("content");
            let ajax = new XMLHttpRequest();
            ajax.onload = function() {
                alert("server response for 'create answer' request was " + ajax.status);
                console.log(ajax);
            };
            ajax.open("PUT", "/record/create/answer?questionId=" + questionId + "&answerText=" + answerText);
            ajax.setRequestHeader(csrfHeader, csrfToken);
            ajax.send();
        }

        function createAnswerFromForm() {
            let q = document.getElementById("enteredQuestion").value;
            let a = document.getElementById("enteredAnswer").value;
            createAnswer(parseInt(q), a);
        }
    </script>
</body>
</html>